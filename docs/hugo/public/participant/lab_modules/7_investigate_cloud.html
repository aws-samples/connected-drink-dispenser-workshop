<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.59.1" />
    <meta name="description" content="">


    <link rel="icon" href="../../images/favicon.png" type="image/png">

    <title>7. Review Cloud Architecture :: Connected Drink Dispenser Workshop</title>

    
    <link href="../../css/nucleus.css" rel="stylesheet">
    <link href="../../css/fontawesome-all.min.css" rel="stylesheet">
    <link href="../../css/hybrid.css" rel="stylesheet">
    <link href="../../css/featherlight.min.css" rel="stylesheet">
    <link href="../../css/perfect-scrollbar.min.css" rel="stylesheet">
    <link href="../../css/auto-complete.css" rel="stylesheet">
    <link href="../../css/atom-one-dark-reasonable.css" rel="stylesheet">
    <link href="../../css/theme.css" rel="stylesheet">
    <link href="../../css/hugo-theme.css" rel="stylesheet">
    
      <link href="../../css/theme-mine.css" rel="stylesheet">
    

    <script src="../../js/jquery-3.3.1.min.js"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    <link rel="stylesheet" href="../../css/adoc.css">
<link rel="stylesheet" href="../../css/tags.css">
<link rel="stylesheet" href="../../css/jquery-ui.min.css">
  </head>
  <body class="" data-url="/participant/lab_modules/7_investigate_cloud.html">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a href="https://cdd.example.com/docs/docs">
    <img src="../../images/cdd_logo.png" alt="Connected Drink Dispenser Workshop" width="50%">
</a>
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="../../js/lunr.min.js"></script>
<script type="text/javascript" src="../../js/auto-complete.js"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/cdd.example.com\/docs";
    
</script>
<script type="text/javascript" src="../../js/search.js"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/participant.html" title="Workshop Participant" class="dd-item 
        parent
        
        
        ">
      <a href="../../participant.html">
          <i class="fas fa-user-graduate"></i>&nbsp;Workshop Participant
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/participant/lab_modules.html" title="Lab Modules" class="dd-item 
        parent
        
        
        ">
      <a href="../../participant/lab_modules.html">
          <i class="fas fa-user-graduate"></i>&nbsp;Lab Modules
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/participant/lab_modules/1_overview.html" title="1. Architecture Overview" class="dd-item 
        
        
        
        ">
      <a href="../../participant/lab_modules/1_overview.html">
          1. Architecture Overview
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/participant/lab_modules/2_laptop_setup.html" title="2. Laptop Setup" class="dd-item 
        
        
        
        ">
      <a href="../../participant/lab_modules/2_laptop_setup.html">
          2. Laptop Setup
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/participant/lab_modules/3_create_account.html" title="3. Create Account/Resources" class="dd-item 
        
        
        
        ">
      <a href="../../participant/lab_modules/3_create_account.html">
          3. Create Account/Resources
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/participant/lab_modules/4_esp_setup.html" title="4. MCU Setup &amp; Test" class="dd-item 
        
        
        
        ">
      <a href="../../participant/lab_modules/4_esp_setup.html">
          4. MCU Setup &amp; Test
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/participant/lab_modules/5_cloud9_setup.html" title="5. Cloud9 Dev Environment" class="dd-item 
        
        
        
        ">
      <a href="../../participant/lab_modules/5_cloud9_setup.html">
          5. Cloud9 Dev Environment
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/participant/lab_modules/6_flash_and_test.html" title="6. Develop, Flash, &amp; Test MCU" class="dd-item 
        
        
        
        ">
      <a href="../../participant/lab_modules/6_flash_and_test.html">
          6. Develop, Flash, &amp; Test MCU
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/participant/lab_modules/7_investigate_cloud.html" title="7. Review Cloud Architecture" class="dd-item 
        parent
        active
        
        ">
      <a href="../../participant/lab_modules/7_investigate_cloud.html">
          7. Review Cloud Architecture
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/participant/lab_modules/8_build_dispenser.html" title="8. Build Dispenser" class="dd-item 
        
        
        
        ">
      <a href="../../participant/lab_modules/8_build_dispenser.html">
          8. Build Dispenser
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/participant/lab_modules/9_final_test.html" title="9. Dispense a Drink!" class="dd-item 
        
        
        
        ">
      <a href="../../participant/lab_modules/9_final_test.html">
          9. Dispense a Drink!
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/presenter.html" title="Setting Up the Workshop" class="dd-item 
        
        
        
        ">
      <a href="../../presenter.html">
          <i class="fas fa-chalkboard-teacher"></i>&nbsp;Setting Up the Workshop
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/presenter/prerequisites.html" title="Prerequisites" class="dd-item 
        
        
        
        ">
      <a href="../../presenter/prerequisites.html">
          <i class="fas fa-greater-than"></i>&nbsp;Prerequisites
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/presenter/deploy.html" title="Deploy Stack" class="dd-item 
        
        
        
        ">
      <a href="../../presenter/deploy.html">
          <i class="fas fa-greater-than"></i>&nbsp;Deploy Stack
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/presenter/repository.html" title="Repository Layout" class="dd-item 
        
        
        
        ">
      <a href="../../presenter/repository.html">
          <i class="fas fa-greater-than"></i>&nbsp;Repository Layout
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/presenter/design_notes.html" title="Design Notes" class="dd-item 
        
        
        
        ">
      <a href="../../presenter/design_notes.html">
          <i class="fas fa-greater-than"></i>&nbsp;Design Notes
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/presenter/design_notes/message_flows.html" title="Message Flows" class="dd-item 
        
        
        
        ">
      <a href="../../presenter/design_notes/message_flows.html">
          <i class="fas fa-greater-than"></i>&nbsp;Message Flows
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://github.com/search?q=topic%3Aiot&#43;org%3Aaws-samples&#43;fork%3Atrue"><i class='fas fa-bookmark'></i> AWS Samples on GitHub</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="footer">
      
    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            <a href='../../'></a> > <a href='../../participant.html'>Workshop Participant</a> > <a href='../../participant/lab_modules.html'>Lab Modules</a> > 7. Review Cloud Architecture
          
         
          
         
          
         
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">

    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              7. Review Cloud Architecture
            </h1>
          

        




	<section class="doc-section level-1"><h2 id="_objectives">Objectives</h2><p>This lab module will walk through how the dispenser, dispenser app, and coupled services interact. It will go into level of detail specific for the workshop. If you would like to review more details, please reference the <a href="../../presenter.html">Setting Up the Workshop</a> documentation for deeper insights.</p>
<p>By then end of this module you will have:</p>
<div class="ulist"><ul><li>An understanding of the relationship between the dispenser (<em>Thing</em>), your Cognito user, and the DynamoDB database tables that track and log dispenser activity and state.</li><li>Seen how the dispenser <em>Thing</em> uses the <a href="https://docs.aws.amazon.com/iot/latest/developerguide/iot-device-shadows.html">Device Shadow Service for AWS IoT</a> to get notified of the requested state changes, and how it uses to acknowledge a dispense <em>request</em> with a <em>dispense</em> response.</li><li>Tested a <em>dispense</em> operation and monitored what takes place in different scenarios.</li><li>Reviewed dispenser activity both in the DynamoDB <em>EventsTable</em> and in the dispenser app logging.</li><li>An understanding of how the dispenser app along with the API Lambda functions control how to give credits to others dispensers, as well as ensuring that a dispense event can on;y be initiated when there sufficient credits.</li></ul></div></section>
<section class="doc-section level-1"><h2 id="_steps_to_complete">Steps to Complete</h2><p>Follow each step in order and use the <strong>Click to open for detailed step-by-step instructions</strong> if required.</p>
<section class="doc-section level-2"><h3 id="_1_understand_the_aws_iot_thing_cognito_user_and_dynamodb_table_relationships">1. Understand the AWS IoT Thing, Cognito User, and DynamoDB Table Relationships</h3><p>As this solution is designed as a software-as-a-service (SaaS) environment, there needs to be a specific relationship between all of the resources to help enforce the security and operational controls of the actions. At a high level this is how the resources are associated with each other:</p>
<figure class="image-block"><img src="../../Relationship_services.svg" alt="Relationship services" width="806" height="646">
<figcaption>Figure 1. Relationship between services</figcaption></figure>
<p>Each thing has a unique X.509 client certificate for authentication allowing the dispenser to connect to AWS IoT and publish and subscribe to the MQTT topics specific for that dispenser. This authorization of MQTT topics comes from a common policy attached to the certificate that uses substitution variables that read the <em>Common Name</em> value from the X.509 certificate which contains the dispenser Id. This allows for an easier management of the authorization policies, as a single policy can be used for all dispensers. The relationship between the dispenser and the user is modeled into a Cognito User attribute, <code>custom:dispenserId</code>, that is read for every API call. Finally, your dispenser has an entry in the DynamoDB <em>DispenserTable</em> that tracks the credit balance and any in-flight or stale command operations.</p>
<p>Go to the AWS Console to review the relationships for your dispenser and your own user in the following AWS services:</p>
<div class="ulist"><ul><li><strong>AWS IoT Core</strong> - View your thing, the attached certificate details, and the policy associated with the certificate. Also, view the other security policy that is associated with your Cognito user (used to monitor update events).</li><li><strong>Amazon Cognito</strong> - From <em>Manage User Pools</em>, select the <em>workshop-users</em>, Users and Groups, then select your username. Note the <code>custom:group</code> and <code>custom:dispenserId</code> attribute values.</li><li><strong>Amazon DynamoDB</strong> - From the <em>DispenserTable</em> review the credits value for your dispenser via the <em>dispenserId</em> sort key. From the <em>DispenserEvents</em> table, query with the partition key equal to your dispenserId. As others start to create and operate their dispensers, filtering will limit to just your events.</li></ul></div>

<div class="expand">
    <div class="expand-label" style="cursor: pointer;text-decoration: underline" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-circle-down' : 'fas fa-chevron-circle-right';});});">
        <i style="font-size:large;" class="fas fa-chevron-circle-right"></i>
        <span>
        
    	
    	Click to open for detailed step-by-step instructions
    	
    	</span>
    </div>
    <div class="expand-content" style="display: none;">
        <div class="olist arabic"><ol class="arabic"><li><p>From the browser tab opened to the AWS Console, click on the <em>Services</em> menu dropdown (upper left next to AWS logo), and type in <em>iot core</em>, then click on <em>IoT Core</em> when the drop-down populates. This will direct you the the AWS IoT Core service page.</p><aside class="admonition-block tip" role="doc-tip"><h6 class="block-title label-only"><span class="title-label">Tip: </span></h6><p>During the workshop you will be changing from service to service quite often. When navigating to a different service via the <em>Service&#8594;SERVICENAME</em>, right-click on the service name and select "Open in a new tab" (or equivalent). This will have all the services referenced within a single browser window on separate tabs.</p></aside></li><li>Click on <em>Get Started</em> to take you to the main page, then select <em>Manage</em> from the left tab. Click on <em>Skip tour</em>. This will take you to the list of things. Either select your thing (same as dispenserId), or click on <em>Search things</em>, which is helpful for large amounts of items.</li><li>From your things page, click on <em>Security</em>. This shows that you have a single X.509 certificate (long hash value) associated with your thing. Click on the certificate which will show details on it. Note that the <strong>Subject</strong> contains values that are parsed when the certificate is presented, and the value for <em>CN</em> (Common Name) is the dispenserId. This is how we can verify the identity of your device.</li><li><p>To continue viewing the IoT relationships, from the Certificate page, click on <em>Policies</em>. This shows what IoT policies are associated with the certificate, and by relationship, to the thing. Click on the policy to view its content, which is a JSON document.</p><p>Notice that all of the resources use the substitution variable <code>${iot:Certificate.Subject.CommonName}</code> as part of the string. When a dispenser connects to AWS IoT the value in the client certificate  <em>CommonName</em>, or <em>CN</em>, is used to replace the variable, making the policy resources unique to each dispenser. This allows for a single policy to used by all the dispensers.</p>
<figure class="listing-block"><figcaption>Abbreviated DispenserLimitedAccess Policy</figcaption>
<pre class="highlight"><code class="language-json" data-lang="json"> {
  "Version": "2012-10-17",
  "Statement": [
    {
      "Condition": {
        "Bool": {
          "iot:Connection.Thing.IsAttached": [
            "true"
          ]
        }
      },
      "Action": [
        "iot:Connect"
      ],
      "Resource": [
        "arn:aws:iot:REGION:ACCOUNT:client/${iot:Connection.Thing.ThingName}"
      ],
      "Effect": "Allow"
    },
    {
      "Action": [
        "iot:Subscribe"
      ],
      "Resource": [
        "arn:aws:iot:REGION:ACCOUNT:topicfilter/$aws/things/${iot:Certificate.Subject.CommonName}/shadow/*",
        "arn:aws:iot:REGION:ACCOUNT:topicfilter/$aws/things/${iot:Certificate.Subject.CommonName}/cmd/${iot:Certificate.Subject.CommonName}"
      ],
      "Effect": "Allow"
    }
  ]
}</code></pre></figure></li><li>Next, from the <em>Services</em> menu, select Cognito, click <em>Manage User Pools</em>, and then click on the <em>workshop-users</em> pool. This is the service that manages the user account you created from the dispenser app. Under <em>General Settings</em> select <em>Users and groups</em> to display all of the user accounts. Search for your username and click on it. At the bottom you will notice a couple of <code>custom:</code> attributes. The first, <code>custom:group</code> denotes that your account is a general <code>user</code> account (extra credit, check out the admin user). The second attribute, <code>custom:dispenserId</code> shows  your dispenserId value. These fields are passed whenever you make an API call from the dispenser app and used by the Lambda functions to validate what actions you are allowed to take.</li><li>From the <em>Services</em> menu navigate to DynamoDB, which contains the database tables. Select <em>Tables</em> from the left menu, select the <em>DispenserTable</em> name, then select Items from the right pane. This table holds a single record for each dispenser. The most important field is <em>credits</em>, and should correspond to the value in the dispenser app ("1" in the table is $1.00 in the dispenser app). This record is modified every time someone gives you credits, or whenever you issue a dispense operation.</li><li>Finally, select the <em>DispenserEvents</em> table from the left pane. You will see all the various log entries for all dispensers. To view just your dispenser&#8217;s events, click on the <em>Scan</em> dropdown and change to <em>Query</em>, for <code>Partition key</code> enter your dispenser&#8217;s value and click on <em>Start Search</em>.</li></ol></div>

    </div>
</div></section>
<section class="doc-section level-2"><h3 id="_2_monitor_shadow_changes_for_a_simple_operation_toggle_led_ring_status">2. Monitor Shadow Changes for a Simple Operation (toggle LED Ring status)</h3><p>The <a href="https://docs.aws.amazon.com/iot/latest/developerguide/iot-device-shadows.html">Device Shadow Service for AWS IoT</a> is a service that can be used by things and applications to set and track the state of device. There are two main sections in the shadow document: the <em>desired</em> state and the <em>reported</em> state. In our solution the desired settings originate from the dispenser app. The dispenser acts upon them and set the correct reported state.</p>
<figure class="image-block"><img src="../../shadow%20state%20changes.svg" alt="shadow state changes" width="943" height="276">
<figcaption>Figure 2. Shadow state changes</figcaption></figure>
<p>To see this in action, from the AWS Console navigate to your Thing in IoT Core, then select <em>Shadow</em> which will show the current shadow document. Note the <code>led</code> attribute in the <em>desired</em> and <em>reported</em> sections, which should be the same. Also notice the value for <code>version</code> in the metadata. This increments each time the shadow is updated. To see how the shadow is working, use the dispenser app to change the state of the LED by either toggling or setting to the other state. You will see the value for <code>led</code> has changed in the shadow document, in both <em>desired</em> and <em>reported</em> sections, and <code>version</code> has incremented.</p>
<p>To see how the shadow works when the device is in a disconnected state, unplug the microcontroller from your laptop. Now, in the dispenser app change the state of the LED and notice that the <em>desired</em> change to show the new value but that the <em>reported</em> state is still what the dispenser was in before being disconnected. Notice also that a new <em>delta</em> section has appeared in the document, containing just this <code>led</code> field. This is automatically calculated by the Shadow service. Plug the microcontroller back into your laptop. Once it has booted and connected AWS IoT, the LED will change to the <em>desired</em> state value and the dispenser will update the <em>reported</em> state. Since <em>desired</em> and <em>reported</em> states are the same, the <em>delta</em> state for the LED is removed.</p>

<div class="expand">
    <div class="expand-label" style="cursor: pointer;text-decoration: underline" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-circle-down' : 'fas fa-chevron-circle-right';});});">
        <i style="font-size:large;" class="fas fa-chevron-circle-right"></i>
        <span>
        
    	
    	Click to open for detailed step-by-step instructions
    	
    	</span>
    </div>
    <div class="expand-content" style="display: none;">
        <aside class="admonition-block note" role="note"><h6 class="block-title label-only"><span class="title-label">Note: </span></h6><p>In this expanded details section, we will only use a small subset of the entire shadow document and hierarchy to show the <em>desired</em>, <em>reported</em>, and <em>delta</em> sections.</p></aside>
<div class="olist arabic"><ol class="arabic"><li><p>Navigate to IoT Core&#8594;Manage&#8594;Things&#8594;Your Thing&#8594;Shadow and review the shadow document. Note that the <em>desired</em> and <em>reported</em> sections are the same. This indicates that the device and requested state from the dispenser app are in sync. At the bottom of the shadow document review the value for <code>version</code> in the metadata. This increments each time the shadow is updated.</p><div class="listing-block"><pre class="highlight"><code class="language-json" data-lang="json">"desired": {
  "led": "off",
  "led_ring": {
    "count": 5,
    "color": "#FF8000"
  }
},
"reported": {
  "led": "off",
  "led_ring": {
    "count": 5,
    "color": "#FF8000"
  }
},
...
"version": 100</code></pre></div></li><li><p>From the dispenser app, toggle or change the state of the LED (in this example from <em>off</em> to <em>on</em>). The dispenser app sets the <em>desired</em> state of the shadow, the dispenser reads this value, turns on the LED, and modifies the <em>reported</em> state to <em>on</em>. You may miss the update in the AWS Console, but check the metadata and notice that the value for <code>version</code> has increased by at least 2 (once for the dispenser app setting the <em>desired</em> state and once when the dispenser updated the <em>reported</em> state).</p><div class="listing-block"><pre class="highlight"><code class="language-json" data-lang="json">"desired": {
  "led": "on",
  "led_ring": {
    "count": 5,
    "color": "#FF8000"
  }
},
"reported": {
  "led": "on",
  "led_ring": {
    "count": 5,
    "color": "#FF8000"
  }
},
...
"version": 102</code></pre></div></li><li><p>To see how the shadow works when the device is in a disconnected state, unplug the microcontroller from your laptop, then toggle or set the LED to the alternate state (in this case from <em>on</em> to <em>off</em>). Notice that the <em>desired</em> and <em>reported</em> states are different, and that there is a <em>delta</em> state which show only those differences. This is useful when you only want to focus on the changes between <em>desired</em> and <em>reported</em> states.</p><div class="listing-block"><pre class="highlight"><code class="language-json" data-lang="json">"desired": {
  "led": "off",
  "led_ring": {
    "count": 5,
    "color": "#FF8000"
  }
},
"delta": {
  "led": "off",
},
"reported": {
  "led": "on",
  "led_ring": {
    "count": 5,
    "color": "#FF8000"
  }
},
...
"version": 103</code></pre></div></li><li><p>To verify that the dispenser reads the shadow state upon restart, plug the dispenser back into your laptop and watch the shadow document. The dispenser will reconcile the states which will remove the attribute from the <em>delta</em> section (or completely remove it).</p><div class="listing-block"><pre class="highlight"><code class="language-json" data-lang="json">"desired": {
  "led": "off",
  "led_ring": {
    "count": 5,
    "color": "#FF8000"
  }
},
"reported": {
  "led": "off",
  "led_ring": {
    "count": 5,
    "color": "#FF8000"
  }
},
...
"version": 105</code></pre></div></li></ol></div>

    </div>
</div></section>
<section class="doc-section level-2"><h3 id="_3_monitor_shadow_mqtt_topics_for_a_complex_operation_dispense_drink">3. Monitor Shadow  MQTT topics for a Complex Operation (Dispense Drink)</h3><p>The shadow can also be used for more complex operations. While changing the state of the LED can be tracked via a single attribute, operations such as dispensing a drink are more complex and require multiple states such as <em>request</em> and <em>response</em>. The dispenser app initiates the dispense operation as a <em>request</em>, and when the dispenser completes the operation it, in turn, sets a corresponding <em>response</em>. We use a short, random, <code>requestId</code> value to match the correlate the <em>request</em> and <em>response</em> states.</p>
<figure class="image-block"><img src="../../req_res_shadow.svg" alt="req res shadow" width="822" height="593">
<figcaption>Figure 3. Tracking request/response using shadow</figcaption></figure>
<p>As we cannot be sure that the dispenser is online, the dispenser app initiates the request and sets the <em>desired</em> state of the shadow with a <code>request</code> object containing the <code>command</code> to execute, a unique <code>requestId</code>, and the <code>timestamp</code> of when the user clicked "Dispense a Drink" in the dispenser app.</p>
<p>To verify, ensure the microcontroller is connected and LED operations take place. Next, use  <em>Test</em> from the IoT Core console and subscribe to the topic <code>$aws/things/dispenserId/shadow/#</code> (replace <code>dispenserId</code> with your value) to track all shadow operations. Next, in the dispenser app click the <em>Dispense!</em> button (should still be green) to initiate a dispense operation. From the <em>MQTT Client</em> tab, you should see a few shadow topic messages. Scroll through and review how the first message sets the <code>request</code> object, and after the dispenser completes turning the pump (indicated by the animated LED pattern on the LED Ring) the <em>reported</em> state is updated with a <code>response</code> object that has the same <code>requestId</code>, and finally that the the <code>request</code> <strong>and</strong> <code>response</code> objects are both deleted from all shadow sections once the response has been reconciliated.</p>
<p>In this situation, we are using the shadow to track the status of a command sent to the dispenser, and the response once it acts upon it.</p>

<div class="expand">
    <div class="expand-label" style="cursor: pointer;text-decoration: underline" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-circle-down' : 'fas fa-chevron-circle-right';});});">
        <i style="font-size:large;" class="fas fa-chevron-circle-right"></i>
        <span>
        
    	
    	Click to open for detailed step-by-step instructions
    	
    	</span>
    </div>
    <div class="expand-content" style="display: none;">
        <div class="olist arabic"><ol class="arabic"><li>Ensure the microcontroller is connected and responds to LED on/off events.</li><li>Navigate to IoT Core&#8594;Test and in the <em>Subscription topic</em> field, enter <code>$aws/things/dispenserId/shadow/#</code> (replace <code>dispenserId</code> with your value) and click <em>Subscribe to topic</em>.</li><li>From the dispenser app, click the <em>Dispense!</em> button (should still be green) to initiate a dispense operation. This should turn on the Ring LED with an animated pattern for a short period of time and create a few messages in the <em>MQTT Client</em>, which indicates that the pump motor has been activated.</li><li><p>Scroll to the bottom (oldest message) and look for the shadow update with <em>desired</em> state that has the first <code>request</code> object.</p><div class="listing-block"><pre class="highlight"><code class="language-json" data-lang="json">{} initial request</code></pre></div></li><li><p>The next message by time will be the dispenser responding to the event publishing to the <em>reported</em> state a <code>response</code> object with the same <code>requestId</code>, signifying that it has completed that request (either with a <em>success</em> or <em>failed</em> indicator).</p><div class="listing-block"><pre class="highlight"><code class="language-json" data-lang="json">{} request and response</code></pre></div></li><li><p>On the cloud side, the matching <code>request</code> and <code>response</code> objects trigger a Lambda function to log the transaction and clear out both objects from the shadow. This is essence reconciling the <em>request</em> to the <em>response</em>, and readying the dispenser for its next operation.</p><div class="listing-block"><pre class="highlight"><code class="language-json" data-lang="json">{} cleared of both</code></pre></div></li></ol></div>

    </div>
</div></section>
<section class="doc-section level-2"><h3 id="_4_review_logging_and_credits">4. Review Logging and Credits</h3><p>Oops! While testing how the Shadow works We used up all of our credits. Each dispense operation costs $1.00, and has been deducted from our dispenser credit, as shown by the dispenser app. Navigate to the DynamoDB <em>DispenserTable</em> and verify the credits match the dispenser app. Also, review the <em>EventsTable</em> for your dispenser (review the first steps in this lab if needed) to see the various logging entries made while testing the Ring LED and drink dispense test.</p>
<p>We use these tables as the <em>source of truth</em> for the status of our dispenser. While the dispenser code you compiled and installed could be modified, a dispense operation can only be performed if there are sufficient credits in the account (e.g., DynamoDB DispenserTable entry). We use the value of the <code>dispenserId</code> across the dispenser app (user account custom attribute), IoT Core (Thing name, Certificate CN) and DynamoDB DispenserTable (dispenserId key) to enforce the desired controls in the overall SaaS application.</p></section>
<section class="doc-section level-2"><h3 id="_5_dispenser_app_overview">5. Dispenser app Overview</h3><p>The dispenser app is your main interface for interacting with the dispenser, eg to dispense a drink, and to check its state. As the dispenser app is running inside your local browser, there are two methods that can be used to track what is the current status. We can continuously <a href="https://en.wikipedia.org/wiki/Polling_(computer_science)">poll</a> via an API to return the status, or use a <a href="https://en.wikipedia.org/wiki/Callback_(computer_programming)">callback</a> mechanism to alert the dispenser app when something has changed. In our app we use the <em>callback</em> method, and specifically it does this by subscribing to the MQTT topics for your specific dispenser. This reduces the overall load on the SaaS service and demonstrates how we can use the features of AWS IoT Core to simplify the implementation.</p>
<p>Modern web browsers have the ability to monitor what is running locally. Our dispenser app has additional debug, or <code>console.log()</code> statements to give an indication when something is happening. From your browser, enable the <em>Web Console</em> (name varies based on browser), and select the <em>Console</em> tab. Now change the status of the LED. Every time you make a change, you will see an <em>Received MQTT message with change in LED or credit status</em> message. This is alerted when an incoming MQTT message of interest such as a shadow update occurs.</p>
<p>These messages then trigger the dispenser app to make an API call requesting the complete status of the dispenser (LED status, credits, etc.), which in turn updates the main dispenser page. If there are no changes being made, no MQTT messages are generated, and subsequently, no API calls are made to request an update to the dispenser app.</p>

<div class="expand">
    <div class="expand-label" style="cursor: pointer;text-decoration: underline" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-circle-down' : 'fas fa-chevron-circle-right';});});">
        <i style="font-size:large;" class="fas fa-chevron-circle-right"></i>
        <span>
        
    	
    	Click to open for detailed step-by-step instructions
    	
    	</span>
    </div>
    <div class="expand-content" style="display: none;">
        <div class="olist arabic"><ol class="arabic"><li>Open the <em>Web Console</em> for your browser:<ol class="loweralpha" type="a"><li>FireFox: Select menu Tool&#8594;Web Developer&#8594;Web Console</li><li>Google Chrome: View&#8594;Developer&#8594;JavaScript Console</li><li>Internet Explorer 11: Either press the <code>F12</code> key or from the Setting Wheel&#8594;F12 Developer Tools&#8594;Console</li><li>Microsoft Edge: From upper right, select <code>&#8230;&#8203;</code>&#8594;More tools&#8594;Developer tools&#8594;Console tab</li><li>Safari: Preferences&#8594;Advanced Tab&#8594;Show developer menu in menu bar (close Preferences), Develop&#8594;Show JavaScript Console</li></ol></li><li>Change the status of the LED with the dispenser connected. Notice the <em>Received MQTT message with change in LED or credit status</em> lines. These a created when the dispenser app, which is subscribed to a set of MQTT topics receives a message. This is an indication that something may have changes and triggers the dispenser app to make an API call to the <code>/status</code> method, which returns the dispenser status parsed from the shadow document <em>and</em> the DynamoDB <em>DispenserTable</em>.</li><li>If there are no changes being made, no MQTT messages are generated, and subsequently, no API calls are made to request an update to the dispenser app.</li></ol></div>

    </div>
</div></section>
<section class="doc-section level-2"><h3 id="_6_share_the_love">6. Share the Love!</h3><p>Now that we have shown how you interact with your dispenser via the dispenser app, let&#8217;s build our credits up to a sufficient level to complete the rest of the lab. To do this, click on the <em>Share the Love!</em> panel underneath the LED status panel and follow the instructions. First, try giving credit to another dispenser number and monitor the <em>Last credit response</em> message (with or without browser logging). Next, try to give yourself credits and note that the gray button to the right does not change to <em>SEND CREDIT!</em>. This is a constraint built into the dispenser app. However, even if you were to make a direct API call, the backend will also deny the request.</p>
<p>Finally, talk to your neighbors and ask them to start sending you credits. You may also see that as the credits increase, the LED Ring will also start to fill until you have at least $1.00, and after that the colors will changes as your balance goes above $2.00, $3.00, etc.</p>
<p>It is recommended that you have at least $2.00 or $3.00 to perform a couple dispenses with a fully built dispenser unit.</p>
<p>Good work!</p></section></section>
<section class="doc-section level-1"><h2 id="_checkpoints">Checkpoints</h2><p>Please ensure the following checkpoints are validated before moving on to the next module.</p>
<div class="olist arabic"><ol class="arabic"><li>The dispenser board operates correctly and you can toggle the LED Ring from the dispenser app</li><li>A dispense operation enables the LED Ring with an animated pattern indicating the microcontroller activates the pump (motor control)</li><li>You have an understanding of how the shadow document and DynamoDB tables are used to track state (LED) and perform command and control (request/response) operations</li></ol></div></section>
<section class="doc-section level-1"><h2 id="_outcomes">Outcomes</h2><p>Why do we use the shadow document for command and control, when it could also be done with regular MQTT messages? While either pattern are good practices, combining all of the operations into a single location makes it easier to follow for the workshop. As long as there is a way to track each request, the mechanism used doesn&#8217;t matter.</p>
<p>One thing that we didn&#8217;t discuss is the LED Ring. In this case, it is used to give a visual indication of the credit levels. From the dispensers perspective, it is another shadow attribute set to manage. But instead of being set by clicking buttons in the dispenser app, this value is programmatically set by the cloud services whenever there is a change in the credit state of a dispenser. This demonstrates that functionality in not static and can be modified in either device (dispenser) or the application (cloud-side).</p></section>





<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="../../participant/lab_modules/6_flash_and_test.html" title="6. Develop, Flash, &amp; Test MCU"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="../../participant/lab_modules/8_build_dispenser.html" title="8. Build Dispenser" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="../../js/clipboard.min.js"></script>
    <script src="../../js/perfect-scrollbar.min.js"></script>
    <script src="../../js/perfect-scrollbar.jquery.min.js"></script>
    <script src="../../js/jquery.sticky.js"></script>
    <script src="../../js/featherlight.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="../../js/modernizr.custom-3.6.0.js"></script>
    <script src="../../js/learn.js"></script>
    <script src="../../js/hugo-learn.js"></script>

    <link href="../../mermaid/mermaid.css" rel="stylesheet" />
    <script src="../../mermaid/mermaid.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <div style="float: right;margin-right: 10px;margin-top: 10px;font-size: smaller;">Copyright Â© 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.</div>

<script src="../../js/fix-adoc.js"></script>
<script src="../../js/jquery-ui.min.js"></script>

  </body>
</html>
